<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DoP Document Verification</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg-color: #050816;
      --card-color: #0b1020;
      --accent-green: #30e88f;
      --accent-red: #ff4b6a;
      --accent-blue: #1f7bff;
      --text-main: #f5f7ff;
      --text-muted: #9aa4c6;
      --border-soft: rgba(255,255,255,0.06);
      --shadow-soft: 0 18px 50px rgba(0,0,0,0.6);
      --radius-lg: 22px;
      --radius-pill: 999px;
      --transition-fast: 0.18s ease-out;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #1a2b5f 0, transparent 50%),
                  radial-gradient(circle at bottom right, #3a134f 0, transparent 50%),
                  linear-gradient(135deg, #030711, #050816);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 32px 16px 40px;
    }

    .top-pill {
      border-radius: var(--radius-pill);
      border: 1px solid rgba(255,255,255,0.06);
      padding: 6px 22px;
      font-size: 13px;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--text-muted);
      background: linear-gradient(90deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01));
      margin-bottom: 24px;
    }

    .layout {
      max-width: 1200px;
      width: 100%;
    }

    .card-main {
      background: radial-gradient(circle at top left, rgba(59,130,246,0.12) 0, transparent 55%),
                  radial-gradient(circle at bottom right, rgba(16,185,129,0.12) 0, transparent 50%),
                  var(--card-color);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      padding: 26px 28px 24px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      backdrop-filter: blur(18px);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .card-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: var(--radius-pill);
      background: rgba(16,185,129,0.13);
      color: #a7f3d0;
      font-size: 12px;
      border: 1px solid rgba(52,211,153,0.35);
    }

    .card-badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 12px rgba(34,197,94,0.9);
    }

    .card-title {
      font-size: 24px;
      font-weight: 600;
      letter-spacing: 0.02em;
      margin-bottom: 4px;
    }

    .card-subtitle {
      font-size: 13px;
      color: var(--text-muted);
    }

    .version-pill {
      font-size: 12px;
      color: var(--text-muted);
      opacity: 0.8;
    }

    .row-main {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      align-items: stretch;
      margin-top: 8px;
    }

    .upload-area {
      flex: 1 1 340px;
      border-radius: var(--radius-lg);
      border: 1px dashed rgba(148,163,184,0.45);
      padding: 18px 18px 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: radial-gradient(circle at top, rgba(59,130,246,0.18) 0, transparent 60%),
                  rgba(15,23,42,0.9);
      position: relative;
      overflow: hidden;
    }

    .upload-area.dragover {
      border-style: solid;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 1px rgba(59,130,246,0.5), 0 18px 45px rgba(15,23,42,0.9);
      transform: translateY(-1px);
    }

    .upload-label {
      font-size: 13px;
      color: var(--text-muted);
    }

    .upload-inner {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn-file-wrapper {
      position: relative;
    }

    .btn-file {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 20px;
      border-radius: var(--radius-pill);
      border: none;
      background: linear-gradient(135deg, #3b82f6, #22c55e);
      color: white;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 14px 30px rgba(34,197,94,0.38);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), filter var(--transition-fast);
      white-space: nowrap;
    }

    .btn-file:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow: 0 18px 40px rgba(34,197,94,0.5);
    }

    .btn-file input {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .file-name {
      font-size: 13px;
      color: var(--text-main);
      opacity: 0.85;
      max-width: 260px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .upload-hint {
      font-size: 12px;
      color: var(--text-muted);
    }

    .check-col {
      flex: 0 0 260px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 10px;
      align-items: flex-start;
    }

    .btn-check {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 26px;
      border-radius: var(--radius-pill);
      border: none;
      background: radial-gradient(circle at 10% 0, rgba(74,222,128,0.4) 0, transparent 55%),
                  linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.02em;
      cursor: pointer;
      box-shadow: 0 20px 45px rgba(21,128,61,0.6);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), filter var(--transition-fast);
      position: relative;
      overflow: hidden;
    }

    .btn-check:hover {
      transform: translateY(-1px);
      filter: brightness(1.06);
      box-shadow: 0 24px 55px rgba(21,128,61,0.7);
    }

    .btn-check:disabled {
      opacity: 0.6;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .btn-check.pulsing {
      animation: pulseGlow 1.4s ease-out infinite;
    }

    @keyframes pulseGlow {
      0% {
        box-shadow: 0 0 0 0 rgba(34,197,94,0.65);
      }
      70% {
        box-shadow: 0 0 0 16px rgba(34,197,94,0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(34,197,94,0);
      }
    }

    .btn-check .spinner {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,0.35);
      border-top-color: white;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .check-hint {
      font-size: 12px;
      color: var(--text-muted);
      max-width: 260px;
      line-height: 1.4;
    }

    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .history-card {
      margin-top: 26px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-soft);
      background: radial-gradient(circle at top left, rgba(37,99,235,0.18) 0, transparent 60%),
                  rgba(10,16,35,0.98);
      padding: 18px 20px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.8);
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }

    .history-title {
      font-size: 14px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .btn-download {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.7);
      color: #e5e7eb;
      font-size: 13px;
      cursor: pointer;
      transition: background var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast);
    }

    .btn-download:hover {
      background: rgba(30,64,175,0.85);
      box-shadow: 0 12px 30px rgba(30,64,175,0.8);
      transform: translateY(-1px);
    }

    .btn-download-icon {
      font-size: 14px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead {
      color: var(--text-muted);
      border-bottom: 1px solid rgba(148,163,184,0.3);
    }

    th, td {
      padding: 7px 4px;
      text-align: left;
    }

    th:first-child, td:first-child { padding-left: 4px; }
    th:last-child, td:last-child { padding-right: 4px; }

    tbody tr {
      border-bottom: 1px solid rgba(15,23,42,0.85);
    }

    tbody tr:last-child {
      border-bottom: none;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 10px;
      border-radius: var(--radius-pill);
      font-size: 12px;
      font-weight: 500;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
    }

    .status-ok {
      background: rgba(22,163,74,0.18);
      color: #bbf7d0;
    }

    .status-ok .status-dot {
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34,197,94,0.9);
    }

    .status-nok {
      background: rgba(248,113,113,0.18);
      color: #fecaca;
    }

    .status-nok .status-dot {
      background: #fb7185;
      box-shadow: 0 0 8px rgba(248,113,113,0.9);
    }

    .status-unknown {
      background: rgba(148,163,184,0.16);
      color: #e5e7eb;
    }

    .status-unknown .status-dot {
      background: #9ca3af;
      box-shadow: 0 0 8px rgba(156,163,175,0.8);
    }

    .file-link {
      color: #93c5fd;
      text-decoration: none;
      font-size: 12px;
    }

    .file-link:hover {
      text-decoration: underline;
    }

    footer {
      margin-top: 22px;
      font-size: 11px;
      color: var(--text-muted);
      text-align: center;
      opacity: 0.9;
    }

    footer span {
      opacity: 0.75;
    }

    /* Modal */

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(15,23,42,0.84) 0, rgba(3,7,18,0.96) 60%);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }

    .modal-backdrop.visible {
      display: flex;
    }

    .modal {
      background: radial-gradient(circle at top left, rgba(59,130,246,0.26) 0, transparent 55%),
                  rgba(15,23,42,0.98);
      border-radius: 20px;
      border: 1px solid rgba(148,163,184,0.45);
      max-width: 480px;
      width: 92%;
      padding: 20px 22px 16px;
      box-shadow: 0 24px 60px rgba(0,0,0,0.9);
      position: relative;
      animation: modalIn 0.22s ease-out;
    }

    @keyframes modalIn {
      from {
        opacity: 0;
        transform: translateY(10px) scale(0.98);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-header {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 10px;
    }

    .modal-icon {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .modal-icon-ok {
      background: radial-gradient(circle at 30% 20%, #bbf7d0 0, #22c55e 40%, #166534 100%);
      box-shadow: 0 0 18px rgba(34,197,94,0.9);
    }

    .modal-icon-nok {
      background: radial-gradient(circle at 30% 20%, #fecaca 0, #fb7185 40%, #b91c1c 100%);
      box-shadow: 0 0 18px rgba(248,113,113,0.95);
    }

    .modal-icon-unknown {
      background: radial-gradient(circle at 30% 20%, #e5e7eb 0, #9ca3af 40%, #4b5563 100%);
      box-shadow: 0 0 18px rgba(148,163,184,0.9);
    }

    .modal-icon span {
      font-size: 18px;
      color: white;
    }

    .modal-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .modal-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .modal-body {
      margin-top: 10px;
      font-size: 13px;
      line-height: 1.5;
      color: #e5e7eb;
    }

    .modal-body-row {
      margin-bottom: 4px;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      margin-top: 14px;
    }

    .btn-modal-close {
      padding: 7px 16px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      font-size: 13px;
      cursor: pointer;
      transition: background var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast);
    }

    .btn-modal-close:hover {
      background: rgba(30,64,175,0.95);
      box-shadow: 0 12px 30px rgba(30,64,175,0.9);
      transform: translateY(-1px);
    }

    .badge-inline {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: var(--radius-pill);
      font-size: 11px;
      margin-left: 4px;
    }

    .badge-inline-ok {
      background: rgba(22,163,74,0.16);
      color: #bbf7d0;
    }

    .badge-inline-nok {
      background: rgba(248,113,113,0.16);
      color: #fecaca;
    }

    .badge-inline-unknown {
      background: rgba(148,163,184,0.18);
      color: #e5e7eb;
    }

    @media (max-width: 768px) {
      body {
        padding: 20px 10px 30px;
      }
      .card-main {
        padding: 18px 16px 16px;
      }
      .row-main {
        flex-direction: column;
      }
      .check-col {
        align-items: stretch;
      }
      .btn-check {
        width: 100%;
        justify-content: center;
      }
      .upload-inner {
        flex-direction: column;
        align-items: flex-start;
      }
      .file-name {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="top-pill">GUARDIAN INDUSTRIES</div>

  <div class="layout">
    <section class="card-main">
      <header class="card-header">
        <div>
          <div class="card-badge">
            <div class="card-badge-dot"></div>
            DoP compliance tool
          </div>
          <h1 class="card-title">DoP Document Verification</h1>
          <p class="card-subtitle">
            Upload the DoP PDF to run an automatic compliance check.
          </p>
        </div>
        <div class="version-pill">
          DoP Checker v1.2<br />
          <span id="version-date">2025-12-02</span>
        </div>
      </header>

      <div class="row-main">
        <div id="upload-area" class="upload-area">
          <div class="upload-label">PDF file</div>
          <div class="upload-inner">
            <div class="btn-file-wrapper">
              <button type="button" class="btn-file">
                Select PDF File
                <input type="file" id="fileInput" accept="application/pdf" />
              </button>
            </div>
            <div id="file-name" class="file-name">No file selected</div>
          </div>
          <div class="upload-hint">
            You can also drag &amp; drop the PDF into this area.
          </div>
        </div>

        <div class="check-col">
          <button type="button" id="checkBtn" class="btn-check">
            <span>Check the document</span>
          </button>
          <div class="check-hint">
            The document will be validated and any issues highlighted.
          </div>
        </div>
      </div>

      <footer class="card-footer">
        <div>Automatic parsing of DoP content and NULL field detection.</div>
        <div>Internal quality tool</div>
      </footer>
    </section>

    <section class="history-card">
      <div class="history-header">
        <div class="history-title">Verification history</div>
        <button type="button" id="downloadReportBtn" class="btn-download">
          <span class="btn-download-icon">⬇</span>
          <span>Download report (Excel)</span>
        </button>
      </div>

      <div class="history-table-wrapper">
        <table>
          <thead>
            <tr>
              <th style="width: 170px;">Time</th>
              <th style="width: 120px;">Status</th>
              <th>Reason</th>
              <th style="width: 220px;">File</th>
            </tr>
          </thead>
          <tbody id="historyBody">
            <!-- Filled dynamically -->
          </tbody>
        </table>
      </div>
    </section>

    <footer>
      Declaration of Performance • <span>Internal quality tool</span>
    </footer>
  </div>

  <!-- Modal -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div id="modalIcon" class="modal-icon modal-icon-unknown">
          <span>!</span>
        </div>
        <div>
          <div id="modalTitle" class="modal-title">Verification result</div>
          <div class="modal-subtitle">Automatic DoP compliance check</div>
        </div>
      </div>

      <div class="modal-body">
        <div class="modal-body-row">
          <strong>Status:</strong>
          <span id="modalStatusText">UNKNOWN</span>
          <span id="modalStatusBadge" class="badge-inline badge-inline-unknown">
            UNKNOWN
          </span>
        </div>
        <div class="modal-body-row">
          <strong>Reason:</strong>
          <span id="modalReason"></span>
        </div>
        <div class="modal-body-row">
          <strong>Null fields:</strong>
          <span id="modalNulls"></span>
        </div>
        <div class="modal-body-row">
          <strong>File:</strong>
          <span id="modalFile"></span>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" id="modalCloseBtn" class="btn-modal-close">Close</button>
      </div>
    </div>
  </div>

  <script>
    // === CONFIG ===
    // Update this when your n8n/ngrok URL changes:
    const API_URL = "https://1713a740d1cd.ngrok-free.app/webhook/dop-check";

    // === STATE ===
    let selectedFile = null;
    const history = [];

    // === ELEMENTS ===
    const fileInput = document.getElementById("fileInput");
    const fileNameEl = document.getElementById("file-name");
    const uploadArea = document.getElementById("upload-area");
    const checkBtn = document.getElementById("checkBtn");
    const historyBody = document.getElementById("historyBody");
    const downloadReportBtn = document.getElementById("downloadReportBtn");

    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalIcon = document.getElementById("modalIcon");
    const modalTitle = document.getElementById("modalTitle");
    const modalStatusText = document.getElementById("modalStatusText");
    const modalStatusBadge = document.getElementById("modalStatusBadge");
    const modalReason = document.getElementById("modalReason");
    const modalNulls = document.getElementById("modalNulls");
    const modalFile = document.getElementById("modalFile");
    const modalCloseBtn = document.getElementById("modalCloseBtn");

    // === HELPERS ===

    function setSelectedFile(file) {
      selectedFile = file || null;
      if (selectedFile) {
        fileNameEl.textContent = selectedFile.name;
        checkBtn.classList.add("pulsing");
      } else {
        fileNameEl.textContent = "No file selected";
        checkBtn.classList.remove("pulsing");
      }
    }

    function setButtonLoading(isLoading) {
      if (isLoading) {
        checkBtn.disabled = true;
        checkBtn.classList.remove("pulsing");
        checkBtn.innerHTML = '<div class="spinner"></div><span>Checking...</span>';
      } else {
        checkBtn.disabled = false;
        checkBtn.innerHTML = "<span>Check the document</span>";
        if (selectedFile) checkBtn.classList.add("pulsing");
      }
    }

    function normalizeResult(raw, fileName) {
      const statusRaw = (raw.status || "").toString().trim().toUpperCase();
      let status = "UNKNOWN";
      if (statusRaw === "OK") status = "OK";
      else if (statusRaw === "NOK") status = "NOK";

      const reason = (raw.reason || "").toString().replace(/^=/, "").trim() || "No details provided.";
      const nullCountValue = raw.nullCount !== undefined && raw.nullCount !== null
        ? raw.nullCount
        : (raw.nulls || 0);
      const nullCount = Number.isNaN(Number(nullCountValue)) ? 0 : Number(nullCountValue);

      return {
        status,
        reason,
        nullCount,
        fileName,
        timestamp: new Date().toISOString()
      };
    }

    function addHistoryEntry(entry) {
      history.unshift(entry);
      renderHistory();
    }

    function renderHistory() {
      historyBody.innerHTML = "";
      history.forEach((entry) => {
        const tr = document.createElement("tr");

        const timeTd = document.createElement("td");
        const date = new Date(entry.timestamp);
        timeTd.textContent = date.toISOString().replace("T", " ").substring(0, 19);
        tr.appendChild(timeTd);

        const statusTd = document.createElement("td");
        const badge = document.createElement("span");
        badge.classList.add("status-badge");
        const dot = document.createElement("span");
        dot.classList.add("status-dot");

        if (entry.status === "OK") {
          badge.classList.add("status-ok");
          badge.textContent = "OK";
        } else if (entry.status === "NOK") {
          badge.classList.add("status-nok");
          badge.textContent = "NOK";
        } else {
          badge.classList.add("status-unknown");
          badge.textContent = "UNKNOWN";
        }
        badge.prepend(dot);
        statusTd.appendChild(badge);
        tr.appendChild(statusTd);

        const reasonTd = document.createElement("td");
        reasonTd.textContent = entry.reason;
        tr.appendChild(reasonTd);

        const fileTd = document.createElement("td");
        const link = document.createElement("span");
        link.textContent = entry.fileName || "-";
        link.className = "file-link";
        fileTd.appendChild(link);
        tr.appendChild(fileTd);

        historyBody.appendChild(tr);
      });
    }

    function showModal(entry, isError) {
      const status = isError ? "ERROR" : entry.status || "UNKNOWN";
      const statusUpper = status.toUpperCase();

      modalStatusText.textContent = statusUpper;

      modalIcon.className = "modal-icon";
      modalStatusBadge.className = "badge-inline";

      if (statusUpper === "OK") {
        modalIcon.classList.add("modal-icon-ok");
        modalStatusBadge.classList.add("badge-inline-ok");
        modalTitle.textContent = "Document is compliant";
        modalStatusBadge.textContent = "OK";
      } else if (statusUpper === "NOK") {
        modalIcon.classList.add("modal-icon-nok");
        modalStatusBadge.classList.add("badge-inline-nok");
        modalTitle.textContent = "Issues detected in document";
        modalStatusBadge.textContent = "NOK";
      } else {
        modalIcon.classList.add("modal-icon-unknown");
        modalStatusBadge.classList.add("badge-inline-unknown");
        modalTitle.textContent = isError ? "Network or server error" : "Verification result";
        modalStatusBadge.textContent = statusUpper;
      }

      modalReason.textContent = entry.reason || "No details provided.";
      modalNulls.textContent = typeof entry.nullCount === "number" ? entry.nullCount : "0";
      modalFile.textContent = entry.fileName || "-";

      modalBackdrop.classList.add("visible");
    }

    function hideModal() {
      modalBackdrop.classList.remove("visible");
    }

    function downloadReportCsv() {
      if (!history.length) {
        alert("There is no data to export yet.");
        return;
      }

      const headers = ["Time", "Status", "Nulls", "Reason", "File"];
      const rows = history.map((e) => {
        const date = new Date(e.timestamp);
        const time = date.toISOString().replace("T", " ").substring(0, 19);
        return [
          time,
          e.status,
          e.nullCount != null ? e.nullCount : 0,
          e.reason.replace(/"/g, '""'),
          e.fileName || ""
        ];
      });

      let csv = headers.join(",") + "\n";
      rows.forEach((r) => {
        const line = r
          .map((v) => `"${String(v).replace(/"/g, '""')}"`)
          .join(",");
        csv += line + "\n";
      });

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");

      const now = new Date();
      const stamp = now.toISOString().replace(/[:]/g, "-").substring(0, 19);
      a.href = url;
      a.download = `dop-report-${stamp}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // === EVENTS ===

    // File input change
    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) setSelectedFile(file);
    });

    // Drag & drop
    ["dragenter", "dragover"].forEach((eventName) => {
      uploadArea.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.classList.add("dragover");
      });
    });

    ["dragleave", "drop"].forEach((eventName) => {
      uploadArea.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.classList.remove("dragover");
      });
    });

    uploadArea.addEventListener("drop", (e) => {
      const dt = e.dataTransfer;
      const file = dt.files && dt.files[0];
      if (file && file.type === "application/pdf") {
        setSelectedFile(file);
        fileInput.value = "";
      } else if (file) {
        alert("Please drop a PDF file.");
      }
    });

    // Check button
    checkBtn.addEventListener("click", async () => {
      if (!selectedFile) {
        alert("Please select a PDF file first.");
        return;
      }

      setButtonLoading(true);

      try {
        const formData = new FormData();
        formData.append("data", selectedFile);

        const response = await fetch(API_URL, {
          method: "POST",
          body: formData
        });

        if (!response.ok) {
          const text = await response.text();
          console.error("Server error:", text);
          const errEntry = {
            status: "ERROR",
            reason: `Server responded with ${response.status}`,
            nullCount: 0,
            fileName: selectedFile.name,
            timestamp: new Date().toISOString()
          };
          addHistoryEntry(errEntry);
          showModal(errEntry, true);
          return;
        }

        let raw;
        try {
          raw = await response.json();
        } catch (jsonErr) {
          console.error("JSON parse error:", jsonErr);
          const errEntry = {
            status: "ERROR",
            reason: "Invalid JSON response from server.",
            nullCount: 0,
            fileName: selectedFile.name,
            timestamp: new Date().toISOString()
          };
          addHistoryEntry(errEntry);
          showModal(errEntry, true);
          return;
        }

        const entry = normalizeResult(raw, selectedFile.name);
        addHistoryEntry(entry);
        showModal(entry, false);

        // In future: here we can call a second webhook for NOK email notifications
        // if (entry.status === "NOK") {
        //   await fetch("YOUR_SECOND_WEBHOOK_URL", {
        //     method: "POST",
        //     headers: { "Content-Type": "application/json" },
        //     body: JSON.stringify(entry)
        //   });
        // }

      } catch (err) {
        console.error("Network error:", err);
        const errEntry = {
          status: "ERROR",
          reason: err.message || "Unknown network error.",
          nullCount: 0,
          fileName: selectedFile ? selectedFile.name : "",
          timestamp: new Date().toISOString()
        };
        addHistoryEntry(errEntry);
        showModal(errEntry, true);
      } finally {
        setButtonLoading(false);
        // Clear file after check
        setSelectedFile(null);
        fileInput.value = "";
      }
    });

    downloadReportBtn.addEventListener("click", downloadReportCsv);

    modalCloseBtn.addEventListener("click", hideModal);
    modalBackdrop.addEventListener("click", (e) => {
      if (e.target === modalBackdrop) hideModal();
    });

    // Init version date (today)
    document.getElementById("version-date").textContent =
      new Date().toISOString().substring(0, 10);
  </script>
</body>
</html>
